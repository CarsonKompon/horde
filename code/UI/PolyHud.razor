@using Sandbox;
@using Sandbox.UI;
@using System.Collections.Generic;
@using System.Linq;
@inherits PanelComponent

<root>
	<div class="free-mouse" />

	@if(Player.Local is not null)
	{
		int i = 0;
		var players = Scene.GetAllComponents<Player>();

		<div class="notifications" @ref="NotificationPanel" >
		</div>

		<div class="leaderboard">
			@foreach(var player in players.OrderBy(x => x.Kills))
			{
				@if(i == 4)
				{
					<div class="more">and @(players.Count() - i) more...</div>
				}
				else if(i < 4)
				{
					<div class="player">
						<div class="info">
							<Image texture=@Texture.LoadAvatar((long)player.Network.OwnerConnection.SteamId) />
							<p class="name">@player.Network.OwnerConnection.DisplayName</p>
						</div>
						<p class="kills">@player.Kills</p>
					</div>
				}
			}
		</div>

		@if(Player.Local.CurrentWeapon is not null)
		{
			var weapon = Player.Local.CurrentWeapon;
			<div class="weapon">
				<img src=@weapon.Icon class="icon" />
				@if(weapon.ClipSize == 0)
				{
					<img src="ui/infinity.png" class="infinite-ammo" />
				}
				else
				{
					<p class="ammo">@weapon.Ammo / @weapon.ClipSize</p>
				}
			</div>
		}
	}
</root>

@code
{
	public static PolyHud Instance { get; private set; }
	Panel NotificationPanel { get; set; }

	protected override void OnStart()
	{
		base.OnStart();
		Instance = this;
	}

	@* protected override void OnUpdate()
	{
		base.OnUpdate();

		if(Input.Pressed("Jump"))
		{
			AddNotification("Picked up REVOLVER!");
		}
	} *@

	public void AddNotification(string text, float time = 3f)
	{
		var notification = new Notification(text, time);
		var popup = NotificationPanel.AddChild<NotificationPopup>();
		popup.Notification = notification;
	}

	protected override int BuildHash() => System.HashCode.Combine( Time.Now );

	public class Notification
	{
		public string Message { get; set; }
		public TimeSince TimeSinceBorn { get; set; }
		public float Time { get; set; } = 3f;

		public Notification(string message, float time = 4f)
		{
			Message = message;
			TimeSinceBorn = 0f;
			Time = time;
		}
	}
}